# realTimeTest 사용 안내서

## 📦 폴더 목적
- **DS18B20_Embedded_ApplicationV2** 펌웨어의 시리얼 통합 테스트 및 자동화된 시나리오 검증을 위한 Python 기반 테스트 환경입니다.

---

## 🛠️ 사용 방법

### 1. 환경 준비
- Python 3.8 이상 권장
- 가상환경(venv) 활성화 후 아래 패키지 설치

```bash
pip install -r requirements.txt
```

### 2. 테스트 실행
- 반드시 보드(Arduino Uno R4 WiFi)가 PC에 연결되어 있어야 합니다.
- COM 포트 번호(기본: COM4)와 속도(115200)가 맞는지 확인하세요.
- 아래 명령어로 테스트를 실행합니다.

```bash
python pyTestStart.py
```

- 실행 시 `scenarioJson` 폴더의 모든 시나리오 목록이 표시되며, 원하는 번호를 입력해 선택할 수 있습니다.
- 0번을 입력하면 테스트가 취소됩니다(`** 0 is cancel **`).
- 테스트가 진행되는 동안 콘솔에 스피너와 함께 `Press CTRL+C twice to force terminate PROCESS.` 안내가 표시됩니다.

> 참고: 직접 pytest 명령어로 실행하려면 `-s` 옵션을 사용해야 입력이 동작합니다.
```bash
pytest -s test_json_driven_copy.py
```

### 3. 로그 파일 위치
- 모든 테스트 결과는 `logs/` 폴더에 자동 저장됩니다.
- 파일명 예시: `pyTest_logs_YYYYMMDD_HHMMSS.log`
- 각 실행마다 별도 파일로 저장되어 추적이 용이합니다.

---

## 📝 시나리오 작성법

### 1. 시나리오 파일 위치
- 모든 시나리오 파일은 `scenarioJson/` 폴더에 JSON 형식으로 저장합니다.
- 예시: `sensor_id_change_flow_fixed.json`

### 2. 시나리오 JSON 구조
```json
{
    "description": "설명",
    "steps": [
        {"send": "menu\n", "expect": "센서 제어 메뉴"},
        {"send": "1\n", "expect": "센서 ID 조정 메뉴"},
        ...
    ]
}
```
- `send`: 시리얼로 전송할 명령(엔터 포함)
- `expect`: 해당 명령 후 반드시 포함되어야 할 출력(부분 문자열 가능)

### 3. 시나리오 선택 방법
- `test_json_driven.py`의 `@pytest.mark.parametrize("specfile", [...])` 부분에서 사용할 시나리오 파일명을 지정합니다.
- 예시:
```python
@pytest.mark.parametrize("specfile", ["sensor_id_change_flow_fixed.json"])
```

---

## 📂 주요 파일 설명
- `test_json_driven.py` : 메인 테스트 러너 (시나리오 기반)
- `conftest.py` : 시리얼 연결 및 공통 함수
- `debug_serial.py` : 시리얼 직접 디버깅용 스크립트
- `logs/` : 모든 테스트 결과 로그 저장 폴더
- `scenarioJson/` : 테스트 시나리오 JSON 파일 저장 폴더

---

## 💡 팁 & 주의사항
- **한글 시나리오 완벽 지원**: UTF-8 인코딩, 한글 메뉴/응답 모두 정상 동작
- **테스트 전 보드 상태 초기화**: 자동 escape 시퀀스로 어떤 상태에서도 정상 시작
- **실제 펌웨어 Serial.print 메시지와 정확히 매칭**해야 테스트가 성공합니다.
- **불필요한 시나리오 파일**(`sensor_id_change_flow.json` 등)은 참고용으로만 보관하세요. 실제 테스트는 `*_fixed.json` 파일을 사용하세요.

---

## 🔗 참고 문서
- `manualPyTest.md` : 문제 발생~해결까지의 전체 히스토리 및 노하우 정리

---

## 🐞 02_multi_id_change_scenario.json 시나리오 문제점 및 해결 과정 정리

### 1. 문제 발생
- `02_multi_id_change_scenario.json` 시나리오가 테스트에서 실패함.
- 첫 번째 step에서 '6' 명령을 보내고 "| 번호 | ID"를 기대했으나, 실제 펌웨어는 초기 상태(`appState: 0`)에서 '6' 입력 시 아무 동작도 하지 않음.
- 시나리오가 메뉴 상태에서만 정상 동작하는데, 테스트 환경에 따라 초기 상태가 달라질 수 있음.

### 2. 원인 분석
- 시나리오가 장치의 현재 상태(메뉴 진입 여부)에 의존적이었음.
- 메뉴 진입 없이 바로 '6'을 보내면 기대하는 출력이 나오지 않음.
- 실제 펌웨어는 메뉴 진입 후에만 '6' 명령이 정상적으로 동작함.

### 3. 해결 방법
- 시나리오의 첫 번째 step을 항상 메뉴 진입(`menu\n`)으로 시작하도록 수정.
- 첫 step을 `{ "send": "menu\n", "expect": "센서 제어 메뉴" }`로 변경하여, 어떤 상태에서 시작하더라도 일관된 테스트가 가능하도록 함.
- 이후 step에서 기존대로 센서 ID 조정 메뉴 진입 및 복수 센서 ID 변경 플로우를 진행.

### 4. 추가 개선 사항
- 테스트 코드에서 시나리오 파일명을 환경 변수(`PYTEST_SCENARIO`)로 전달하고, 테스트 러너가 이를 읽어 사용하도록 개선.
- 시나리오가 실제 펌웨어 출력과 정확히 매칭되도록 기대값(부분 문자열)도 점검.

### 5. 최종 결과
- 시나리오가 어떤 초기 상태에서도 정상적으로 통과함을 확인.
- 테스트 자동화의 신뢰성과 재현성이 크게 향상됨.
- 향후 모든 시나리오 작성 시, 초기 상태 진입(예: 메뉴 진입) step을 명시적으로 추가하는 것이 권장됨.

---

## ✅ 02_multi_id_change_scenario.json 시나리오 테스트 통과 보고

2025-08-02 기준, `02_multi_id_change_scenario.json` 시나리오가 pytest 기반 자동화 테스트에서 정상적으로 통과되었습니다.

### 주요 내용
- 복수 센서 ID 변경 메뉴 자동화 시나리오가 실제 펌웨어 동작과 완벽하게 매칭됨을 확인.
- 모든 단계(`menu` 진입, 센서 ID 조정, 자동 주소순 할당, 복수 센서 선택 및 ID 변경, 상태창 확인)가 기대값과 일치.
- 테스트 결과는 `logs/pyTest_logs_YYYYMMDD_HHMMSS.log`에 저장되어 재현 및 추적 가능.

### 개선 및 권장 사항
- 시나리오 작성 시, 항상 초기 상태 진입(예: 메뉴 진입) step을 명시적으로 추가할 것.
- 환경 변수(`PYTEST_SCENARIO`)를 통한 시나리오 파일명 전달 방식으로 자동화 신뢰성 강화.
- 실제 펌웨어 출력과 기대값(부분 문자열)이 정확히 매칭되는지 반드시 검증.


본 시나리오는 기능의 기본적인 성공 사례를 테스트하는 좋은 시작점입니다. 하지만 소프트웨어의 안정성과 완성도를 높이기 위해서는 위에서 제안된 **예외 처리, 사용자 취소, 경계 조건**과 관련된 테스트 케이스들을 추가하여 시나리오를 확장하는 것이 매우 중요합니다.
---


이 시나리오는 여러 센서를 다룰 때 발생할 수 있는 기본적인 상호작용 문제를 검증하는 데 효과적입니다. 하지만 실제 사용 환경에서 발생할 수 있는 더 복잡하고 예측하기 어려운 상황에 대비하기 위해서는, **성공, 실패, 취소 등 다양한 케이스를 조합한 복합 시나리오**를 설계하여 테스트 커버리지를 높이는 것이 중요합니다. 이를 통해 펌웨어의 안정성을 한층 더 강화할 수 있습니다.

**문의/확장/기여는 언제든 환영합니다!**
